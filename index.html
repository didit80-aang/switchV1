<!doctype html>
<html lang="id">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <link rel="icon" href="icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Switch Control - ESP8266</title>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful');
        })
        .catch(function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
    });
  }
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-content {
            flex: 1;
            min-width: 250px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: white;
        }

        .device-info {
            color: #93c5fd;
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab.active {
            background: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-3px);
        }

        .relay-card {
            display: flex;
            flex-direction: column;
        }

        .relay-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .relay-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .relay-icon.on {
            background: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        .relay-icon.off {
            background: #6b7280;
        }

        .relay-info {
            flex: 1;
            margin-right: 15px;
        }

        .relay-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: white;
            word-break: break-word;
        }

        .relay-label {
            color: #93c5fd;
            font-size: 0.85rem;
        }

        .relay-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        .btn-edit {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-on {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .btn-on:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-off {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-off:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .sensor-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sensor-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .sensor-icon.temp {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .sensor-icon.humid {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .sensor-value {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1;
            margin: 5px 0;
            color: white;
        }

        .sensor-label {
            color: #93c5fd;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-top: 20px;
            height: 380px;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: calc(100% - 30px);
            margin-top: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #93c5fd;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .schedule-list {
            margin-top: 20px;
        }

        .schedule-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .schedule-info {
            flex: 1;
        }

        .schedule-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-icon:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
        }

        .day-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .day-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            color: #93c5fd;
        }

        .day-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .day-btn:hover {
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #93c5fd;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .info-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .info-card h3 {
            color: #93c5fd;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .info-card p {
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-icon {
            font-size: 36px;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #93c5fd;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-header h2 {
            font-size: 1.3rem;
            color: white;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .relay-form-group {
            margin-bottom: 20px;
        }

        .relay-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .relay-input-group .form-input {
            flex: 1;
        }

        .relay-input-group .btn {
            width: auto;
            min-width: 100px;
            padding: 12px 20px;
        }

        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Token input styling */
        .token-input {
            font-family: monospace;
            letter-spacing: 0.5px;
        }

        .token-hint {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
                justify-content: center;
            }
            
            .header-content {
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }

            .tabs {
                justify-content: center;
            }

            .tab {
                padding: 10px 18px;
                font-size: 14px;
            }
            
            .chart-container {
                padding: 20px;
                height: 350px;
            }
            
            .sensor-value {
                font-size: 1.8rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .relay-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .relay-icon {
                align-self: flex-end;
            }
            
            .relay-input-group {
                flex-direction: column;
            }
            
            .relay-input-group .btn {
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .chart-container {
                height: 320px;
                padding: 15px;
            }
            
            .modal-content {
                padding: 20px;
                margin: 10px;
            }
            
            .tab {
                padding: 8px 15px;
                font-size: 13px;
            }
            
            .status {
                font-size: 14px;
            }
            
            .device-info {
                font-size: 0.8rem;
            }
        }

        @supports (-webkit-touch-callout: none) {
            .card {
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
        }

        @-moz-document url-prefix() {
            .card {
                background: rgba(15, 23, 42, 0.95);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üïπÔ∏è Smart Switch Control</h1>
                <p class="device-info" id="deviceInfo">Device ID: esp8266_001, Token: smartcontrol</p>
            </div>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Terputus</span>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="control">
                ‚ö° Kontrol
            </button>
            <button class="tab" data-tab="schedule">
                üïê Jadwal
            </button>
            <button class="tab" data-tab="monitor">
                üìä Monitoring
            </button>
            <button class="tab" data-tab="settings">
                ‚öôÔ∏è Pengaturan
            </button>
            <button class="tab" data-tab="connection">
                üì° Koneksi
            </button>
            <button class="tab" data-tab="info">
                ‚ÑπÔ∏è Info
            </button>
        </div>
        
        <div id="control" class="tab-content active">
            <div class="grid" id="relayGrid">
                <!-- Relay cards akan diisi oleh JavaScript -->
            </div>
        </div>
        
        <div id="schedule" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2>Jadwal Otomatis</h2>
                    <button class="btn-primary" onclick="showScheduleModal()">
                        ‚ûï Tambah Jadwal
                    </button>
                </div>
                <div id="scheduleList" class="schedule-list">
                    <!-- Schedule list akan diisi oleh JavaScript -->
                </div>
            </div>
        </div>
        
        <div id="monitor" class="tab-content">
            <div class="grid">
                <div class="card sensor-card">
                    <div class="sensor-icon temp">üå°Ô∏è</div>
                    <div>
                        <div class="sensor-label">Suhu Ruangan</div>
                        <div class="sensor-value" id="tempValue">--¬∞C</div>
                    </div>
                </div>
                <div class="card sensor-card">
                    <div class="sensor-icon humid">üíß</div>
                    <div>
                        <div class="sensor-label">Kelembaban</div>
                        <div class="sensor-value" id="humidValue">--%</div>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 10px; font-size: 1.2rem; color: white;">Grafik Suhu & Kelembaban</h3>
                <div class="chart-wrapper">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="settings" class="tab-content">
            <div class="card">
                <h2 style="font-size: 1.3rem; margin-bottom: 20px; color: white;">‚öôÔ∏è Pengaturan Relay</h2>
                
                <div class="relay-form-group">
                    <label class="form-label">Relay 1</label>
                    <div class="relay-input-group">
                        <input type="text" id="relay1Name" class="form-input" 
                               placeholder="Nama Relay 1" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(1)">
                            üíæ Simpan
                        </button>
                    </div>
                </div>
                
                <div class="relay-form-group">
                    <label class="form-label">Relay 2</label>
                    <div class="relay-input-group">
                        <input type="text" id="relay2Name" class="form-input" 
                               placeholder="Nama Relay 2" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(2)">
                            üíæ Simpan
                        </button>
                    </div>
                </div>
                
                <div class="relay-form-group">
                    <label class="form-label">Relay 3</label>
                    <div class="relay-input-group">
                        <input type="text" id="relay3Name" class="form-input" 
                               placeholder="Nama Relay 3" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(3)">
                            üíæ Simpan
                        </button>
                    </div>
                </div>
                
                <div class="relay-form-group">
                    <label class="form-label">Relay 4</label>
                    <div class="relay-input-group">
                        <input type="text" id="relay4Name" class="form-input" 
                               placeholder="Nama Relay 4" maxlength="30">
                        <button class="btn btn-success" onclick="saveRelayName(4)">
                            üíæ Simpan
                        </button>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveAllRelayNames()">
                        üíæ Simpan Semua Nama
                    </button>
                    <button class="btn btn-secondary" onclick="resetRelayNames()">
                        ‚Ü∫ Reset ke Default
                    </button>
                </div>
            </div>
        </div>
        
        <div id="connection" class="tab-content">
            <div class="connection-grid">
                <div class="card">
                    <h2 style="font-size: 1.3rem; margin-bottom: 20px; color: white;">üì° Pengaturan Koneksi</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Device ID</label>
                        <input type="text" id="deviceId" class="form-input token-input" 
                               placeholder="contoh: livingroom001" maxlength="30">
                        <p style="color: #93c5fd; font-size: 0.85rem; margin-top: 5px;">
                            ID unik perangkat ESP8266 (huruf, angka, underscore)
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Token</label>
                        <input type="text" id="topicPrefix" class="form-input token-input" 
                               placeholder="contoh: smartcontrol" maxlength="30">
                        <div class="token-hint">
                            Token digunakan untuk autentikasi MQTT. <br>
                            Format topic: <span id="tokenFormat">smartcontrol/esp8266_001/[topic]</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Broker MQTT</label>
                        <select id="mqttBroker" class="form-input">
                            <option value="wss://broker.hivemq.com:8884/mqtt">HiveMQ (Public)</option>
                            <option value="wss://test.mosquitto.org:8081/mqtt">Mosquitto Test</option>
                            <option value="custom">Kustom</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customBrokerGroup" style="display: none;">
                        <label class="form-label">URL Broker Kustom</label>
                        <input type="text" id="customBrokerUrl" class="form-input" 
                               placeholder="wss://broker.example.com:8884/mqtt">
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveConnectionSettings()">
                            üíæ Simpan & Terapkan
                        </button>
                        <button class="btn btn-primary" onclick="loadConnectionSettings()">
                            ‚Ü∫ Muat Pengaturan
                        </button>
                        <button class="btn btn-secondary" onclick="resetConnectionSettings()">
                            üóëÔ∏è Reset Default
                        </button>
                    </div>
                </div>
                
                <div class="card info-card">
                    <div class="info-icon">üì°</div>
                    <h3>Informasi Koneksi</h3>
                    <p><strong>Format Topic:</strong> <span id="topicFormat">smartcontrol/esp8266_001/[topic]</span></p>
                    <p><strong>Broker Saat Ini:</strong> <span id="currentBroker">HiveMQ (Public)</span></p>
                    <p><strong>Status Koneksi:</strong> <span id="mqttStatusText">Menghubungkan...</span></p>
                </div>
            </div>
        </div>
        
        <div id="info" class="tab-content">
            <div class="grid">
                <div class="card info-card">
                    <div class="info-icon">üè†</div>
                    <h3>Informasi Sistem</h3>
                    <p><strong>Device ID:</strong> <span id="infoDeviceId">esp8266_001</span></p>
                    <p><strong>Token:</strong> <span id="infoTopicPrefix">smartcontrol</span></p>
                    <p><strong>Nama Relay:</strong></p>
                    <div id="infoRelayNames">Loading...</div>
                </div>
                
                <div class="card info-card">
                    <div class="info-icon">‚öôÔ∏è</div>
                    <h3>Cara Menggunakan</h3>
                    <p><strong>1. Setup Koneksi:</strong> Masukkan Device ID dan Token di tab "Koneksi"</p>
                    <p><strong>2. Kontrol Manual:</strong> Klik tombol pada relay untuk kontrol perangkat</p>
                    <p><strong>3. Jadwal Otomatis:</strong> Atur jadwal untuk automasi perangkat</p>
                    <p><strong>4. Kustomisasi:</strong> Ubah nama relay di tab "Pengaturan"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Jadwal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeScheduleModal()">√ó</button>
            <h2 class="modal-header">Tambah Jadwal Baru</h2>
            
            <div class="form-group">
                <label class="form-label">Relay</label>
                <select id="scheduleRelay" class="form-input">
                    <!-- Options akan diisi oleh JavaScript -->
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Jam</label>
                    <input type="number" id="scheduleHour" class="form-input" min="0" max="23" value="6">
                </div>
                <div class="form-group">
                    <label class="form-label">Menit</label>
                    <input type="number" id="scheduleMinute" class="form-input" min="0" max="59" value="0">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Aksi</label>
                <select id="scheduleAction" class="form-input">
                    <option value="1">Nyalakan</option>
                    <option value="0">Matikan</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Hari</label>
                <div class="day-buttons" id="dayButtons">
                    <button type="button" class="day-btn active" onclick="toggleDay(0)">Min</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(1)">Sen</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(2)">Sel</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(3)">Rab</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(4)">Kam</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(5)">Jum</button>
                    <button type="button" class="day-btn active" onclick="toggleDay(6)">Sab</button>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="saveSchedule()">üíæ Simpan</button>
                <button class="btn btn-secondary" onclick="closeScheduleModal()">‚ùå Batal</button>
            </div>
        </div>
    </div>

    <script>
        // ========== VARIABEL GLOBAL ==========
        let mqttClient = null;
        let connected = false;
        
        let relays = [
            { id: 1, name: 'Lampu Ruang Tamu', status: false },
            { id: 2, name: 'Lampu Kamar', status: false },
            { id: 3, name: 'AC', status: false },
            { id: 4, name: 'Kipas Angin', status: false }
        ];
        
        let schedules = [];
        let tempData = [];
        let humidData = [];
        let tempChart = null;
        let selectedDays = 127;

        // ========== PENGATURAN DEFAULT ==========
        const DEFAULT_SETTINGS = {
            deviceId: 'esp8266_001',
            topicPrefix: 'smartcontrol',
            mqttBroker: 'wss://broker.hivemq.com:8884/mqtt'
        };

        let currentSettings = { ...DEFAULT_SETTINGS };

        // ========== FUNGSI LOCAL STORAGE ==========
        function saveSettings() {
            localStorage.setItem('smarthome_settings', JSON.stringify(currentSettings));
            console.log('‚úÖ Pengaturan disimpan:', currentSettings);
        }

        function loadSettings() {
            const saved = localStorage.getItem('smarthome_settings');
            if (saved) {
                try {
                    currentSettings = JSON.parse(saved);
                    console.log('‚úÖ Pengaturan dimuat:', currentSettings);
                } catch (e) {
                    console.error('‚ùå Error loading settings:', e);
                    currentSettings = { ...DEFAULT_SETTINGS };
                }
            }
            updateSettingsForm();
            updateConnectionInfo();
        }

        function resetSettings() {
            currentSettings = { ...DEFAULT_SETTINGS };
            saveSettings();
            updateSettingsForm();
            updateConnectionInfo();
            alert('‚úÖ Pengaturan direset ke default');
        }

        function updateSettingsForm() {
            document.getElementById('deviceId').value = currentSettings.deviceId;
            document.getElementById('topicPrefix').value = currentSettings.topicPrefix;
            document.getElementById('mqttBroker').value = currentSettings.mqttBroker;
            
            if (currentSettings.mqttBroker === 'custom') {
                document.getElementById('customBrokerGroup').style.display = 'block';
                document.getElementById('customBrokerUrl').value = currentSettings.customBrokerUrl || '';
            } else {
                document.getElementById('customBrokerGroup').style.display = 'none';
            }
        }

        function updateConnectionInfo() {
            // Update header info
            document.getElementById('deviceInfo').textContent = 
                `Device ID: ${currentSettings.deviceId}, Token: ${currentSettings.topicPrefix}`;
            
            // Update info tab
            document.getElementById('infoDeviceId').textContent = currentSettings.deviceId;
            document.getElementById('infoTopicPrefix').textContent = currentSettings.topicPrefix;
            
            // Update connection tab
            const broker = currentSettings.mqttBroker === 'custom' 
                ? currentSettings.customBrokerUrl 
                : currentSettings.mqttBroker;
            document.getElementById('currentBroker').textContent = broker;
            
            // Update topic format
            const topicFormat = `${currentSettings.topicPrefix}/${currentSettings.deviceId}/[topic]`;
            document.getElementById('topicFormat').textContent = topicFormat;
            document.getElementById('tokenFormat').textContent = topicFormat;
        }

        // ========== FUNGSI MQTT ==========
        function getFullTopic(topic) {
            return `${currentSettings.topicPrefix}/${currentSettings.deviceId}/${topic}`;
        }

        function initMQTT() {
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
                connected = false;
                updateConnectionStatus(false);
            }

            try {
                updateMqttStatus('Menghubungkan...');
                
                const brokerUrl = currentSettings.mqttBroker === 'custom' 
                    ? currentSettings.customBrokerUrl 
                    : currentSettings.mqttBroker;
                
                mqttClient = mqtt.connect(brokerUrl, {
                    clientId: 'web_' + Math.random().toString(36).substr(2, 9),
                    clean: true,
                    reconnectPeriod: 5000,
                    connectTimeout: 10000
                });

                mqttClient.on('connect', () => {
                    console.log('‚úÖ Connected to MQTT broker:', brokerUrl);
                    connected = true;
                    updateConnectionStatus(true);
                    updateMqttStatus('Terhubung');

                    // Subscribe ke semua topic yang diperlukan
                    const topics = [
                        getFullTopic('status'),
                        getFullTopic('temperature'),
                        getFullTopic('humidity'),
                        getFullTopic('scheduler'),
                        getFullTopic('relaynames'),
                        getFullTopic('deviceinfo')
                    ];

                    topics.forEach(topic => {
                        mqttClient.subscribe(topic, (err) => {
                            if (!err) {
                                console.log(`‚úÖ Subscribed to: ${topic}`);
                            }
                        });
                    });

                    // Request data dari ESP8266
                    setTimeout(() => {
                        mqttClient.publish(getFullTopic('requestnames'), 'request');
                        mqttClient.publish(getFullTopic('requestinfo'), 'request');
                    }, 1000);
                });

                mqttClient.on('message', (topic, message) => {
                    handleMessage(topic, message.toString());
                });

                mqttClient.on('error', (err) => {
                    console.error('‚ùå MQTT Error:', err);
                    connected = false;
                    updateConnectionStatus(false);
                    updateMqttStatus('Error: ' + err.message);
                });

                mqttClient.on('close', () => {
                    connected = false;
                    updateConnectionStatus(false);
                    updateMqttStatus('Terputus');
                });

                mqttClient.on('reconnect', () => {
                    console.log('üîÑ Reconnecting to MQTT...');
                    updateMqttStatus('Menyambung ulang...');
                });
            } catch (err) {
                console.error('‚ùå Failed to initialize MQTT:', err);
                updateMqttStatus('Gagal menghubungkan');
            }
        }

        function handleMessage(topic, message) {
            console.log(`üì® MQTT Message: ${topic} -> ${message}`);
            
            const baseTopic = `${currentSettings.topicPrefix}/${currentSettings.deviceId}/`;
            
            if (topic === baseTopic + 'status') {
                const states = message.split(',');
                relays.forEach((relay, i) => {
                    if (i < states.length) {
                        relay.status = states[i] === '1';
                    }
                });
                renderRelays();
            }
            else if (topic === baseTopic + 'temperature') {
                const temp = parseFloat(message);
                if (!isNaN(temp)) {
                    document.getElementById('tempValue').textContent = temp.toFixed(1) + '¬∞C';
                    addTempData(temp);
                }
            }
            else if (topic === baseTopic + 'humidity') {
                const humid = parseFloat(message);
                if (!isNaN(humid)) {
                    document.getElementById('humidValue').textContent = humid.toFixed(1) + '%';
                    addHumidData(humid);
                }
            }
            else if (topic === baseTopic + 'scheduler') {
                try {
                    const data = JSON.parse(message);
                    if (data.schedules && Array.isArray(data.schedules)) {
                        schedules = data.schedules.map((s, i) => ({
                            id: Date.now() + i,
                            enabled: s.enabled !== undefined ? s.enabled : true,
                            relay: s.relay,
                            hour: s.hour,
                            minute: s.minute,
                            action: s.action,
                            days: s.days
                        }));
                        // Render schedules dengan nama relay yang benar
                        renderSchedules();
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing scheduler:', e);
                }
            }
            else if (topic === baseTopic + 'relaynames') {
                try {
                    const data = JSON.parse(message);
                    if (data.names && Array.isArray(data.names)) {
                        // Simpan nama relay yang baru
                        relays.forEach((relay, i) => {
                            if (data.names[i]) {
                                relay.name = data.names[i];
                            }
                        });
                        
                        // Update semua komponen yang menggunakan nama relay
                        updateRelayNameInputs();
                        renderRelays();
                        renderSchedules(); // PERBAIKAN: Render ulang schedules
                        updateInfoTab();
                        
                        console.log('‚úÖ Relay names updated:', relays);
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing relay names:', e);
                }
            }
            else if (topic === baseTopic + 'deviceinfo') {
                try {
                    const data = JSON.parse(message);
                    console.log('üì° Device info received:', data);
                    if (data.deviceId) {
                        currentSettings.deviceId = data.deviceId;
                        updateConnectionInfo();
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing device info:', e);
                }
            }
        }

        function updateConnectionStatus(isConnected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if (isConnected) {
                dot.classList.add('connected');
                text.textContent = 'Terhubung';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Terputus';
            }
        }

        function updateMqttStatus(status) {
            const statusElement = document.getElementById('mqttStatusText');
            if (statusElement) {
                statusElement.textContent = status;
            }
        }

        // ========== FUNGSI KONEKSI ==========
        function saveConnectionSettings() {
            const deviceId = document.getElementById('deviceId').value.trim();
            const topicPrefix = document.getElementById('topicPrefix').value.trim();
            const brokerSelect = document.getElementById('mqttBroker').value;
            
            if (!deviceId || !topicPrefix) {
                alert('‚ùå Device ID dan Token tidak boleh kosong!');
                return;
            }
            
            // Validasi device ID (hanya huruf, angka, dan underscore)
            if (!/^[a-zA-Z0-9_]+$/.test(deviceId)) {
                alert('‚ùå Device ID hanya boleh mengandung huruf, angka, dan underscore!');
                return;
            }
            
            // Validasi topic prefix
            if (!/^[a-zA-Z0-9_]+$/.test(topicPrefix)) {
                alert('‚ùå Token hanya boleh mengandung huruf, angka, dan underscore!');
                return;
            }
            
            currentSettings.deviceId = deviceId;
            currentSettings.topicPrefix = topicPrefix;
            currentSettings.mqttBroker = brokerSelect;
            
            if (brokerSelect === 'custom') {
                const customUrl = document.getElementById('customBrokerUrl').value.trim();
                if (!customUrl) {
                    alert('‚ùå URL Broker kustom tidak boleh kosong!');
                    return;
                }
                if (!customUrl.startsWith('wss://') && !customUrl.startsWith('ws://')) {
                    alert('‚ùå URL broker harus diawali dengan wss:// atau ws://');
                    return;
                }
                currentSettings.customBrokerUrl = customUrl;
            }
            
            saveSettings();
            updateConnectionInfo();
            
            // Reconnect dengan pengaturan baru
            if (confirm('‚úÖ Pengaturan disimpan! Inisialisasi ulang koneksi MQTT?')) {
                initMQTT();
            }
        }

        function loadConnectionSettings() {
            loadSettings();
            alert('‚úÖ Pengaturan dimuat!');
        }

        function resetConnectionSettings() {
            if (confirm('Reset semua pengaturan koneksi ke default?')) {
                resetSettings();
            }
        }

        // ========== FUNGSI KUSTOMISASI NAMA RELAY ==========
        function saveRelayName(relayId) {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }
            
            const input = document.getElementById(`relay${relayId}Name`);
            const newName = input.value.trim();
            
            if (newName.length === 0) {
                alert('‚ùå Nama tidak boleh kosong!');
                return;
            }
            
            if (newName.length > 30) {
                alert('‚ùå Nama maksimal 30 karakter!');
                return;
            }
            
            const relay = relays.find(r => r.id === relayId);
            if (relay) {
                relay.name = newName;
                
                const data = {
                    names: relays.map(r => r.name)
                };
                
                mqttClient.publish(getFullTopic('relaynames'), JSON.stringify(data), { retain: true });
                
                renderRelays();
                renderSchedules(); // PERBAIKAN: Render ulang schedules
                updateInfoTab();
                
                alert(`‚úÖ Nama Relay ${relayId} berhasil diubah menjadi: ${newName}`);
            }
        }
        
        function saveAllRelayNames() {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }
            
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`relay${i}Name`);
                const newName = input.value.trim();
                
                if (newName.length === 0) {
                    alert(`‚ùå Nama Relay ${i} tidak boleh kosong!`);
                    return;
                }
                
                if (newName.length > 30) {
                    alert(`‚ùå Nama Relay ${i} maksimal 30 karakter!`);
                    return;
                }
                
                relays[i-1].name = newName;
            }
            
            const data = {
                names: relays.map(r => r.name)
            };
            
            mqttClient.publish(getFullTopic('relaynames'), JSON.stringify(data), { retain: true });
            
            renderRelays();
            renderSchedules(); // PERBAIKAN: Render ulang schedules
            updateInfoTab();
            
            alert('‚úÖ Semua nama relay berhasil disimpan!');
        }
        
        function resetRelayNames() {
            if (confirm('Reset semua nama relay ke default?')) {
                const defaultNames = [
                    'Lampu Ruang Tamu',
                    'Lampu Kamar',
                    'AC',
                    'Kipas Angin'
                ];
                
                relays.forEach((relay, i) => {
                    relay.name = defaultNames[i];
                    document.getElementById(`relay${relay.id}Name`).value = defaultNames[i];
                });
                
                if (connected) {
                    const data = {
                        names: defaultNames
                    };
                    mqttClient.publish(getFullTopic('relaynames'), JSON.stringify(data), { retain: true });
                }
                
                renderRelays();
                renderSchedules(); // PERBAIKAN: Render ulang schedules
                updateInfoTab();
                
                alert('‚úÖ Nama relay berhasil direset ke default!');
            }
        }
        
        function updateRelayNameInputs() {
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`relay${i}Name`);
                if (input) {
                    input.value = relays[i-1].name;
                }
            }
        }
        
        function updateInfoTab() {
            const infoHtml = relays.map((relay, i) => 
                `<div style="margin-bottom: 5px;">‚Ä¢ ${relay.name} (Relay ${relay.id})</div>`
            ).join('');
            
            document.getElementById('infoRelayNames').innerHTML = infoHtml;
        }
        
        // ========== FUNGSI RELAY ==========
        function toggleRelay(id) {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }
            
            const relay = relays.find(r => r.id === id);
            if (!relay) return;
            
            const newStatus = !relay.status;
            mqttClient.publish(getFullTopic(`relay${id}`), newStatus ? 'ON' : 'OFF');
            
            relay.status = newStatus;
            renderRelays();
        }
        
        function editRelayName(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector('.tab[data-tab="settings"]').classList.add('active');
            document.getElementById('settings').classList.add('active');
            
            setTimeout(() => {
                const input = document.getElementById(`relay${id}Name`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        function renderRelays() {
            const grid = document.getElementById('relayGrid');
            grid.innerHTML = relays.map(relay => `
                <div class="card relay-card">
                    <div class="relay-header">
                        <div class="relay-info">
                            <div class="relay-name">${relay.name}</div>
                            <div class="relay-label">Relay ${relay.id}</div>
                        </div>
                        <div class="relay-icon ${relay.status ? 'on' : 'off'}">
                            ‚ö°
                        </div>
                    </div>
                    <button class="btn ${relay.status ? 'btn-on' : 'btn-off'}" 
                            onclick="toggleRelay(${relay.id})" 
                            ${!connected ? 'disabled' : ''}>
                        ${relay.status ? '‚óè NYALA' : '‚óã MATI'}
                    </button>
                    <div class="relay-actions">
                        <button class="btn-edit" onclick="editRelayName(${relay.id})">
                            ‚úèÔ∏è Ubah Nama
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ========== FUNGSI JADWAL ==========
        function showScheduleModal() {
            const modal = document.getElementById('scheduleModal');
            selectedDays = 127;
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons.forEach(btn => btn.classList.add('active'));
            
            const relaySelect = document.getElementById('scheduleRelay');
            relaySelect.innerHTML = '';
            relays.forEach(relay => {
                const option = document.createElement('option');
                option.value = relay.id;
                option.textContent = `${relay.name} (Relay ${relay.id})`;
                relaySelect.appendChild(option);
            });
            
            modal.classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
        }

        function toggleDay(dayIndex) {
            selectedDays ^= (1 << dayIndex);
            const dayButtons = document.querySelectorAll('.day-btn');
            dayButtons[dayIndex].classList.toggle('active');
        }

        function saveSchedule() {
            if (!connected) {
                alert('‚ö†Ô∏è Tidak terhubung ke MQTT broker!');
                return;
            }

            const schedule = {
                id: Date.now(),
                enabled: true,
                relay: parseInt(document.getElementById('scheduleRelay').value),
                hour: parseInt(document.getElementById('scheduleHour').value),
                minute: parseInt(document.getElementById('scheduleMinute').value),
                action: parseInt(document.getElementById('scheduleAction').value),
                days: selectedDays
            };

            if (schedule.hour < 0 || schedule.hour > 23) {
                alert('‚ùå Jam harus antara 0-23!');
                return;
            }
            
            if (schedule.minute < 0 || schedule.minute > 59) {
                alert('‚ùå Menit harus antara 0-59!');
                return;
            }

            schedules.push(schedule);
            
            const data = {
                schedules: schedules.map(s => ({
                    enabled: s.enabled,
                    relay: s.relay,
                    hour: s.hour,
                    minute: s.minute,
                    action: s.action,
                    days: s.days
                }))
            };
            
            mqttClient.publish(getFullTopic('scheduler'), JSON.stringify(data), { retain: true });
            
            renderSchedules();
            closeScheduleModal();
            alert('‚úÖ Jadwal berhasil disimpan!');
        }

        function deleteSchedule(id) {
            if (!confirm('Hapus jadwal ini?')) return;
            
            schedules = schedules.filter(s => s.id !== id);
            
            const data = {
                schedules: schedules.map(s => ({
                    enabled: s.enabled,
                    relay: s.relay,
                    hour: s.hour,
                    minute: s.minute,
                    action: s.action,
                    days: s.days
                }))
            };
            
            mqttClient.publish(getFullTopic('scheduler'), JSON.stringify(data), { retain: true });
            
            renderSchedules();
            alert('‚úÖ Jadwal berhasil dihapus!');
        }

        function toggleScheduleEnabled(id) {
            const schedule = schedules.find(s => s.id === id);
            if (schedule) {
                schedule.enabled = !schedule.enabled;
                
                const data = {
                    schedules: schedules.map(s => ({
                        enabled: s.enabled,
                        relay: s.relay,
                        hour: s.hour,
                        minute: s.minute,
                        action: s.action,
                        days: s.days
                    }))
                };
                
                mqttClient.publish(getFullTopic('scheduler'), JSON.stringify(data), { retain: true });
                
                // Hanya update schedule yang diubah, tidak perlu render ulang semua
                const scheduleItem = document.querySelector(`.schedule-item:nth-child(${schedules.findIndex(s => s.id === id) + 1})`);
                if (scheduleItem) {
                    const checkbox = scheduleItem.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = schedule.enabled;
                    }
                }
            }
        }

        function renderSchedules() {
            const list = document.getElementById('scheduleList');
            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            if (schedules.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üïê</div>
                        <p>Belum ada jadwal. Klik "Tambah Jadwal" untuk membuat jadwal baru.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = schedules.map(s => {
                // PERBAIKAN: Selalu gunakan nama relay terbaru dari array relays
                const relay = relays.find(r => r.id === s.relay);
                const relayName = relay ? relay.name : `Relay ${s.relay}`;
                const activeDays = days.filter((_, i) => s.days & (1 << i)).join(', ');
                
                return `
                    <div class="schedule-item">
                        <div class="schedule-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <input type="checkbox" 
                                       ${s.enabled ? 'checked' : ''} 
                                       onchange="toggleScheduleEnabled(${s.id})"
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <strong style="font-size: 0.95rem;">${relayName} - ${s.action === 1 ? 'üü¢ Nyalakan' : 'üî¥ Matikan'}</strong>
                            </div>
                            <div style="color: #93c5fd; font-size: 0.85rem;">
                                ‚è∞ ${String(s.hour).padStart(2, '0')}:${String(s.minute).padStart(2, '0')} 
                                | üìÖ ${activeDays}
                            </div>
                        </div>
                        <button class="btn-icon btn-danger" onclick="deleteSchedule(${s.id})" title="Hapus">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ========== FUNGSI CHART ==========
        function addTempData(temp) {
            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            tempData.push({ time, temp });
            if (tempData.length > 20) tempData.shift();
            updateChart();
        }

        function addHumidData(humid) {
            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            humidData.push({ time, humid });
            if (humidData.length > 20) humidData.shift();
            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Suhu (¬∞C)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.15)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: 'Kelembaban (%)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.15)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: '#cbd5e1',
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#e2e8f0',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                size: 12,
                                weight: 'normal'
                            },
                            bodyFont: {
                                size: 12
                            },
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(255, 255, 255, 0.08)',
                                drawBorder: false,
                                drawTicks: false
                            },
                            ticks: {
                                color: '#93c5fd',
                                font: {
                                    size: 10,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 8,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            border: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            suggestedMin: 0,
                            suggestedMax: 40,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.08)',
                                drawBorder: false,
                                drawTicks: false
                            },
                            ticks: {
                                color: '#ef4444',
                                font: {
                                    size: 10,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 8,
                                callback: function(value) {
                                    return value + '¬∞C';
                                }
                            },
                            title: {
                                display: false
                            },
                            border: {
                                display: false
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            suggestedMin: 0,
                            suggestedMax: 100,
                            grid: {
                                drawOnChartArea: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#3b82f6',
                                font: {
                                    size: 10,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 8,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: false
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!tempChart) return;
            
            const labels = tempData.map(d => d.time);
            const temps = tempData.map(d => d.temp);
            const humids = humidData.map(d => d.humid);
            
            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = temps;
            tempChart.data.datasets[1].data = humids;
            tempChart.update('none');
        }

        // ========== INISIALISASI ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Smart Home Control Initialized');
            
            // Load pengaturan dari localStorage
            loadSettings();
            
            // Setup event listener untuk broker selection
            document.getElementById('mqttBroker').addEventListener('change', function() {
                const customGroup = document.getElementById('customBrokerGroup');
                if (this.value === 'custom') {
                    customGroup.style.display = 'block';
                } else {
                    customGroup.style.display = 'none';
                }
            });
            
            // Render initial content
            renderRelays();
            renderSchedules();
            initChart();
            updateInfoTab();
            updateRelayNameInputs();
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                    
                    // PERBAIKAN: Jika membuka tab schedule, render ulang dengan nama terbaru
                    if (tabName === 'schedule') {
                        renderSchedules();
                    }
                });
            });
            
            // Inisialisasi MQTT dengan pengaturan yang sudah dimuat
            initMQTT();
            
            // Cek jadwal setiap menit
            setInterval(() => {
                if (!connected) return;
                
                const now = new Date();
                const currentMinute = now.getHours() * 60 + now.getMinutes();
                const currentDay = now.getDay();
                
                schedules.forEach(schedule => {
                    if (schedule.enabled && (schedule.days & (1 << currentDay))) {
                        const scheduleMinute = schedule.hour * 60 + schedule.minute;
                        if (currentMinute === scheduleMinute) {
                            console.log(`‚è∞ Schedule triggered: Relay ${schedule.relay} ${schedule.action === 1 ? 'ON' : 'OFF'}`);
                            mqttClient.publish(getFullTopic(`relay${schedule.relay}`), 
                                schedule.action === 1 ? 'ON' : 'OFF');
                        }
                    }
                });
            }, 60000);
            
            // Request data dari ESP8266 setiap 30 detik
            setInterval(() => {
                if (connected) {
                    mqttClient.publish(getFullTopic('requestnames'), 'request');
                    mqttClient.publish(getFullTopic('requestinfo'), 'request');
                }
            }, 30000);
        });

        window.addEventListener('beforeunload', () => {
            if (mqttClient && connected) {
                mqttClient.end();
                console.log('üëã MQTT connection closed');
            }
        });
    </script>
</body>
</html>
